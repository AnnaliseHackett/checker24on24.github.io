name: XMR_Worker_Monitor_247
on:
  schedule:
    - cron: '*/5 * * * *' 
  workflow_dispatch:      

jobs:
  check_and_log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Check Logic
        run: |
          WALLET="8A1jQsrACPy4yWbGzCJRFMZCay6sfnsDnY73dnN1dbiQPTb3fmi2e1hhHMQpmbUc4gKkAPWgaykERTJsFSAukW1iLDJUigP"
          curl -s "https://www.supportxmr.com/api/miner/$WALLET/identifiers" > online_now.json
          
          python3 -c "
          import json, time, os
          now = int(time.time() * 1000)
          
          # Đọc file history cũ
          history = {}
          if os.path.exists('data.json'):
              try:
                  with open('data.json', 'r') as f:
                      history = json.load(f)
              except:
                  history = {}
          
          # Đọc dữ liệu online mới từ API
          try:
              with open('online_now.json', 'r') as f:
                  online_now = json.load(f)
          except:
              online_now = []

          # Logic cập nhật
          for name in online_now:
              if name not in history or history[name].get('status') == 'offline':
                  history[name] = {'status': 'online', 'since': now}
          
          for name in list(history.keys()):
              if name not in online_now and history[name].get('status') == 'online':
                  history[name] = {'status': 'offline', 'since': now}
          
          # Ghi lại vào data.json
          with open('data.json', 'w') as f:
              json.dump(history, f, indent=2)
          "

      - name: Save to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Monitor-Bot"
          git add data.json
          # Commit nếu có thay đổi, nếu không có gì mới thì bỏ qua (exit 0)
          git commit -m "Bot: Updated worker status [$(date)]" || exit 0
          git push
